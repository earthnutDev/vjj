name: æµ‹è¯•ç‡è‡ªåŠ¨åŒ–å·¥å…·

on:
  push:
    branches: [no-main]
  workflow_dispatch:
    inputs:
      version:
        description: 'è§¦å‘åŸå› ï¼ˆé€‰å¡«ï¼‰'
        required: false
        default: 'æ‰‹åŠ¨è§¦å‘'
      ref:
        description: 'åˆ†æ”¯ï¼ˆğŸ‰‘ï¼‰'
        required: false
        default: ''

jobs:
  test:
    # åœ¨æäº¤çš„ä»£ç åŒ…å« `version` å­—æ ·æ—¶æ‰è¿è¡Œè¯¥åŠ¨ä½œ
    # æˆ–è€…æ‰‹åŠ¨è§¦å‘
    name: è¿è¡Œæµ‹è¯•å¹¶å°†æµ‹è¯•ç‡æäº¤åˆ° Codecov å’Œ coveralls
    runs-on: ubuntu-latest
    # contains(github.event.head_commit.message,'version') æ£€æŸ¥æäº¤ä¿¡æ¯æ˜¯å¦åŒ…å« version
    # startsWith(github.event.head_commit.message,'version') æ£€æŸ¥æäº¤ä¿¡æ¯æ˜¯å¦ä»¥ version å¼€å¤´
    # endsWith(github.event.head_commit.message,'version') æ£€æŸ¥æäº¤ä¿¡æ¯æ˜¯å¦ä»¥ version ç»“å°¾
    # github.event_name == 'workflow_dispatch' æ£€æŸ¥æ˜¯å¦ä¸ºæ‰‹åŠ¨è§¦å‘
    if: |
      (github.event_name == 'push' && (startsWith(github.event.head_commit.message, 'version') || contains(github.event.head_commit.message, 'coverage'))) ||
      github.event_name == 'workflow_dispatch'
    steps:
      - name: ä»£ç æ£€å‡º
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref || github.ref_name }}
          fetch-depth: 1

      - name: åˆå§‹åŒ– Node å¹¶è®¾å®š Node ç‰ˆæœ¬
        uses: actions/setup-node@v4
        with:
          node-version: 22.x

      - name: å®‰è£… dependencies ä¾èµ–
        run: npm install

      - name: è¿è¡Œæµ‹è¯•
        run: npx jest --coverage

      - name: ä¸Šä¼ æµ‹è¯•ç»“æœåˆ° Codecov
        uses: codecov/codecov-action@v5
        with:
          # token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/lcov.info
          verbose: true

      - name: ä¸Šä¼ æµ‹è¯•ç»“æœåˆ° coveralls
        uses: coverallsapp/github-action@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path-to-lcov: ./coverage/lcov.info
